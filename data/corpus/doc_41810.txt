Четвёртый выпуск реализации kdbus для ядра Linux

Грег Кроа-Хартман (Greg Kroah-Hartman) опубликовал четвёртую версию патчей с реализацией kdbus, надёжной, быстрой и безопасной системы обмена сообщениями, поддерживающей доставку сообщений в режиме точка-точка и в режиме мультикаст (от одного отправителя к группе получателей). Kdbus может использоваться не только для альтернативных реализаций D-Bus, не требующих запуска отдельного демона в пространстве пользователя, но и в виде самодостаточного IPC, например, данная система уже поддерживается в systemd. Система D-Bus является универсальной шиной, нашедшей широкое распространение в дистрибутивах Linux. При этом ключевыми недостатками данной системы, обусловленными реализацией D-Bus в пространстве пользователя, является слишком низкая скорость передачи сообщений и неприменимость для приложений, предъявляющих повышенные требования ко времени задержки доставки сообщений. Из-за высоких задержек D-Bus многие проекты вынуждены создавать собственные реализации транспортного слоя, например, подобные обособленные системы применяются для передачи данных в PulseAudio, Wayland, во фреймворке аутентификации платформы Tizen (запросы аутентификации, связанные с одним действием в интерфейсе должны отработать без задержек для корректной отрисовки результата). Реализованный на уровне ядра Kdbus решает данные проблемы и открывает новые горизонты для использования D-Bus. Переход на Kdbus позволит унифицировать разрозненные реализации межпроцессного взаимодействия и даст возможность сократить дублирование кода между разными проектами. Kdbus также предоставляет средства для передачи метаданных, что даёт возможность применять идентификацию и аутентификацию для участников обмена данными. Кроме того, kdbus предоставляет общую для всей шины систему последовательной нумерации сообщений, что решает проблемы с упорядочиванием сообщений, переданных по разным каналам. В четвёртой версии патчей продолжено проведение внутренней реструктуризации и чистки. Пересмотрена и переработана логика работы квот, для защиты от DoS-атак 50% ресурсов теперь всегда резервируется для принимающих уведомления соединений, а остальное отдаётся для удалённых узлов. Задействованы новые функции vfs_iter_write(), kstrdup_const(), kfree_const(), появившиеся в ядре 4.0-rc1. Во время установки прекращено использование второго набора слайсов, что приводит к сокращению фрагментации, снижению потребления памяти и упрощению работы. Из основных достоинств реализации шины kdbus на уровне ядра отмечается: Высокая производительность за счёт минимизации переключения контекста процессов, меньшего выполнения операций копирования, сокращения системных вызовов, использования memfd; Высокая безопасность из-за исключения влияния пользовательских процессов на содержимое шины и использования механизмов ядра для управления передачей данных, в том числе с возможностью контроля со стороны модулей LSM; Более высокая устойчивость к DoS-атакам из-за возможности выделения для отправителя ограниченного временного среза при выполнении ресурсоёмких операций и назначения более высоких приоритетов для важных узлов; К сообщениям могут быть прикреплены различные метаданные; Пригодность для приложений, обрабатывающих большие потоки данных, с возможностью расстановки сообщений в очереди на основании приоритетов и задания глобального упорядочивания сообщений. Например, некоторые разработчики нашли применение в kdbus даже для передачи звука в системе; Неподверженность многим состояниям гонки, которые трудно устранить в реализации на уровне пользователя. Например, ситуация отсоединения клиента от шины только при условии отсутствия сообщений в его очереди; Возможность мониторинга на уровне ядра. Привилегированные пользователи могут подключиться к потоку сообщений без создания специализированных механизмов в пространстве пользователя; Возможность прямой доставки сообщения без помещения в очередь, что удобно при организации обработки запросов активации по шине; Возможность доступа к шине на ранних и заключительных этапах загрузки, в том числе во время выполнения initrd.