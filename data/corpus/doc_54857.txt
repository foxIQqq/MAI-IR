Уязвимость в NPM-пакете node-netmask, применяемом в 270 тысячах проектов

В NPM-пакете node-netmask, насчитывающем около 3 млн загрузок в неделю и используемом в качестве зависимости у более 270 тысяч проектов на GitHub, выявлена уязвимость (CVE-2021-28918), позволяющая обойти проверки, в которых сетевая маска используется для определения вхождения в диапазоны адресов или для фильтрации. Проблема устранена в выпуске node-netmask 2.0.0. Уязвимость позволяет добиться обработки внешнего IP-адреса как адреса из внутренней сети и наоборот, а при определённой логике использования модуля node-netmask в приложении совершить атаки SSRF (Server-side request forgery),RFI (Remote File Inclusion) и LFI (Local File Inclusion) для обращения к ресурсам во внутренней сети и включения в цепочку выполнения внешних или локальных файлов. Проблема заключается в том, что в соответствии со спецификацией строковые значения адресов, начинающиеся с нуля, должны интерпретироваться как восьмеричные числа, но модуль "node-netmask" не учитывает данную особенность и обрабатывает их как десятичные числа. Например, атакующий может запросить ресурс, указав значение "0177.0.0.1", которое в десятичном представлении соответствует "127.0.0.1" (число 0177 в восьмеричной системе равно 127 в десятичной), но модуль "node-netmask" отбросит ноль, и обработает 0177.0.0.1" как "177.0.0.1". В приложении при оценке правил доступа не будет определена тождественность с "127.0.0.1" и ресурс будет загружен с "0177.0.0.1" (фактически с 127.0.0.1), несмотря на запрет обращения к адресам loopback-интерфейса. Аналогично при обращении к приложению атакующий может указать адрес "0127.0.0.1", который тождественен "87.0.0.1", но в модуле "node-netmask" будет обработан как "127.0.0.1" (т.е. приложение разрешит доступ к операциям с 127.0.0.1, несмотря на то, что фактически указан внешний адрес). Подобным образом можно обмануть и проверку обращения к интранет адресам, указав значения подобные "012.0.0.1" (эквивалент "10.0.0.1", но при проверке в node-netmask будет обработан как 12.0.0.1). Выявившие проблему исследователи называют проблему катастрофичной и приводят несколько сценариев атак, но большинство из них выглядят умозрительными. Например, говорится о возможности атаковать приложение на базе Node.js, устанавливающее внешние соединения для запроса ресурса на основе параметров или данных входного запроса, но конкретно приложение не называется и не детализируется. Даже если найти приложения, выполняющие загрузку ресурсов на основе введённых IP-адресов, не совсем ясно, как можно применить сценарий с отдачей фиктивного ресурса без подсоединения к локальной сети или без получения контроля за "зеркальными" IP-адресами. Исследователи предполагают, что владельцы адресов в подсетях 87.0.0.1/8 и 177.0.0.0/8 имеют возможность обойти ограничение доступа к 127.0.0.1. Более реалистичным сценарием является использование уязвимости для обхода различных списков блокировки, реализованных на стороне приложения. Проблема также может применяться для обмена определения интранет-диапазонов в NPM-модуле "private-ip". netmaskseesthisas–>netmaskseesthisas–>…thennetmaskdefinestherequest…ornetmaskallowstherequest(SSRF)NotableRange01201010810.0.0.0/8014012121010.0.0.0/80144010010064100.64.0.0/1002200144144100100.64.0.0/100177012712787127.0.0.0/802610177177127127.0.0.0/802510169169Err:502169.254.0.0/160373*0251251169169.254.0.0/160254*0172172122172.16.0.0/120376*0254254172172.16.0.0/120300*0192192Err:502192.0.0.0/240306*0198198Err:502198.18.0.0/150313*0203203131203.0.113.0/240360*0240240160240.0.0.0/4 * - превышает 254, но не исключается сбой некоторых приложений и в этом случае Дополнение: Аналогичная проблема выявлена во многих библиотеках для других языков. Проблеме подвержена стандартная библиотека std::net::Ipv4Addr языка Rust, частично стандартная библиотека ipaddress языка Python (как восьмеричные интерпретируются значения до 08), а также Perl-модули из CPAN Net-Netmask (исправлено в версии 2.0), Net-CIDR-Lite, Net-IPAddress-Util и Data-Validate-IP. Проблема отсутствует в perl-модулях NetAddr-IP и Net-Subnet.