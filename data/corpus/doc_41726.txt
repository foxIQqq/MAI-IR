Выпуск Pyston 0.3, реализации языка Python с JIT-компилятором

После шести месяцев разработки доступен третий выпуск проекта Pyston, в рамках которого компанией Dropbox, в которой работает Гвидо ван Россум, развивается реализация языка Python, созданная с использованием наработок проекта LLVM. Реализация примечательна применением современных технологий JIT-компиляции и нацелена на достижение высокой производительности, близкой к производительности традиционных системных языков, таких как C++. Код Pyston написан на языке C++ и распространяется под лицензией Apache. В отличие от проекта PyPy, также продвигающего идею применения JIT для ускорения выполнения Python-скриптов, в Pyston используется не трассирующий JIT, базирующийся на компиляции в машинный код часто выполняемых циклов, а применяемый в современных JavaScript-движках JIT на основе трансляции отдельных методов (method-at-a-time), который, по мнению инженеров Dropbox, является более перспективной технологией. Принцип работы Pyston сводится к разбору кода на языке Python и его трансляции в промежуточное представление LLVM (IR, Intermediate Representation). Далее IR-представление проходит обработку в оптимизаторе LLVM и передаётся для исполнения в JIT-движок LLVM, который преобразует IR-представление в машинный код. Для получения информации о типах переменных для программ на динамическом языке Python применяется техника вероятностного предсказания типов объектов с последующим уточнением правильности выбора типа в процессе выполнения. Таким образом Pyston постоянно варьирует выполнение между двумя ветками - быстрой, когда данные о предсказанных типах подтверждаются, и медленной, используемой в случае рассогласования данных о типе. Работа может осуществляться в многопоточном режиме, допускающем параллельное выполнение нескольких нитей кода на языке Python и избавленном от глобальной блокировки интерпретатора (GIL, global interpreter lock). При подготовке нового выпуска большое внимание было уделено оптимизиации производительности и избавлению от узких мест, в рамках движения проекта от стадии неоптимизированного прототипа к формированию полноценного продукта. В текущем виде производительность Pyston уже в некоторых тестах опережает CPython. В среднем выигрыш в производительности составляет всего 1%, но в отдельных тестах наблюдается рост производительности до двух раз, который сводится на нет отставанием, наблюдаемым при выполнении некоторых ещё не оптимизированных операций. Например, производительность выполнения скомпилированного кода уже достаточно велика, но использование JIT-компиляции приводит к достаточно весомым задержкам при запуске. В Pyston пока используется достаточно медленный интерпретатор AST и генерируется слишком большой код LLVM IR, что замедляет стадию компиляции. Оставляет желать лучшего и система распределения памяти, которая пока отстаёт от CPython. В будущих выпусках будут предприняты меры для устранения данных недостатков. Вторым важным направлением развития Pyston 0.3 стала работа по улучшению совместимости с CPython. Проект пока ограничен поддержкой Python 2.7 и постепенно расширяется, позволяя запускать всё более крупные и сложные приложения. В конечном счёте разработчики намерены обеспечить возможность запуска с использованием Pyston серверного кода Dropbox. В настоящее время Pyston уже успешно выполняет все вспомогательные внутренние скрипты, используемые для сборки. При тестировании возможности импорта различных компонентов, в Pyston 0.3 удалось успешно импортировать 117 стандартных библиотек и 27 модулей с расширениями. С одной стороны, общее число библиотек и модулей CPython в два раза больше и предстоит проделать большую работу по обеспечению совместимости, но, с другой стороны, при тестировании выпуска Pyston 0.2 результаты были в два раза хуже - удалось загрузить 56 библиотек и 12 модулей. Прогресс отмечается в поддержке C API, причем не только по загрузке модулей, содержащих код на языке Си, но в плане поддержки внутреннего кода CPython, что позволяет напрямую переносить в Pyston большие блоки кода из CPython. В настоящее время объём кода импортированный из CPython уже приблизился к объёму кода, специально написанного для Pyston. Подобный подход значительно ускоряет разработку, давая возможность сосредоточиться на ключевых особенностях проекта, не тратя много времени на рутинные операции по обеспечению совместимости.