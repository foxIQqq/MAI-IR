Атака на заблокированный ПК через USB

Сами Камкар (Samy Kamkar), исследователь безопасности, известный созданием различных замысловатых устройств для проведения атак, таких как кейлоггер в USB-зарядке телефона, представил свою новую разработку - PoisonTap. В рамках проекта PoisonTap подготовлена практическая реализация атаки BadUSB, позволяющая получить доступ к прокэшированным в браузере сессионным cookie и параметрам аутентификации через подключение к USB-порту компьютера специального устройства. Атака применима к заблокированным компьютерам, независимо от используемых ОС, и может быть совершена когда владелец на время отлучился от своего ПК, оставив его с заблокированным экраном без присмотра. Для атаки используется самый дешёвый одноплатный компьютер Raspberry Pi Zero, продаваемый за $5. На устройство загружен дистрибутив Linux, настроенный для эмуляции сетевого адаптера по USB, по DHCP объявляющий себя в качестве шлюза для локальной подсети 128.0.0.0. При подключении такого устройства к USB-порту, компьютер жертвы воспринимает его как новую сетевую плату, через которую доступен шлюз для обращения к локальной сети, охватывающей половину адресного пространства (устройство представляется как 1.0.0.1 с сетевой маской 128.0.0.0). Новый сетевой интерфейс менее приоритетен на компьютере жертвы, но так как подсеть задана явно, то подпадающий под эту подсеть трафик уходит через новый сетевой интерфейс независимо от наличия шлюза по умолчанию на более приоритетном интерфейсе. На устройстве запускается подставной DNS-сервер, выдающий фиктивные ответы для запросов имён хостов, что позволяет переадресовать к PoisonTap все запросы и сохранить в кэше привязку доменов к сторонним адресам, в том числе организовать доступ к внутренним хостам локальной сети при помощи техники DNS rebinding. Для сбора данных на устройстве PoisonTap запускается специальное приложение с реализацией простого http-сервера, который перехватывает все незашифрованные запросы по HTTP с компьютера жертвы. Если на компьютере пользователя остаётся открытым web-браузер, то с большой долей вероятности некоторые страницы периодически обращаются во вне, например, для обновления рекламных блоков, статистики, AJAX-вставок и т.п. Перехватив такое обращение программа атакущего обрабатывает его и генерирует ответ, в зависимости от запроса содержащий специально оформленный HTML или JavaScript. Через подстановку скрытых блоков iframe организуется обращение к списку популярных сайтов из web-браузера жертвы (используется список из миллиона сайтов от рейтинга Alexa). Если пользователь ранее открывал участвующий в переборе сайт и у него прокэшированы параметры сеанса, то браузер вместе с запросом отправит имеющиеся cookie, а так как трафик контролируется на устройстве атакующего, незашифрованные cookie будут перехвачены. В том числе перехватываются cookie для сайтов, ранее открытых по HTTPS, если данные cookie были установлены без флага Secure, т.е. отправляются и для HTTPS и для HTTP. Кроме того, в перехваченном трафике выявляются и подменяются популярные JavaScript-библиотеки, запрашиваемые через типовые сети доставки контента. Подменённые библиотеки, например JQuery, могут применяться для продолжения атаки после отсоединения USB-устройства. Так как подменённые JavaScript-библиотеки оседают в кэше, то в дальнейшем, при открытии пользователем страниц, запрашивающих данные JavaScript-библиотеки, будет выдан вариант из кэша, в который в процессе атаки был встроен код атакующего. Данным способом можно обеспечить перехват сессионных Cookie для будущих входов на сайты, к которым в данный момент не имеется активных сеансов. В процессе атаки также может быть запущен JavaScript-код, выполняющий функции бэкдора. При помощи WebSocket скрипт устанавливает соединение с внешним сервером атакующего (не с PoisonTap, а с реальным внешним хостом) и поддерживает данное соединение в активном состоянии. Пока соединение активно, атакующий может со стороны внешнего сервера в любое время передать команду скрипту и выполнить подстановку iframe или запустить код на JavaScript в контексте текущего сайта.