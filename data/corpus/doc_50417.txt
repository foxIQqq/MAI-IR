Уязвимость в TP-Link SR20, позволяющая получить root-доступ из локальной сети

Мэтью Гаррет (Matthew Garrett), известный разработчик ядра Linux, в своё время получивший от Фонда СПО премию за вклад в развитие свободного ПО, обнаружил уязвимость в устройстве TP-Link SR20, сочетающем функции беспроводного маршрутизатора и шлюза для управления устройствами в умном доме (Zigbee/ZWave hub). Уязвимость позволяет получить полный контроль за устройством и выполнить на нём произвольные команды с правами root при наличии доступа к домашней локальной сети (например, в случае взлома одного из незащищённых IoT-устройств, атака может быть перенесена на маршрутизатор для полного контроля за локальной сетью). Проблема связана с реализацией протокола TDDP (TP-Link Device Debug Protocol), обработчик которого запускается по умолчанию. Первая версия протокола TDDP поддерживает выполнение запросов без аутентификации, но во второй версии для доступа требуется передача пароля пользователя admin. По умолчанию применяется вторая версия протокола, но оказалось, что поддержка первой версии сохранена и изменив один байт в заголовке пакета можно откатиться на версию, не требующую аутентификации. Дальнейший разбор показал, что в составе пакета TDDP передаётся два строковых параметра - имя файла обработчика и имя файла конфигурации. При получении команды выполняется функция tddp_execCmd("cd /tmp; tftp -gr %s %s &",luaFile,remote_address) , которая запускает утилиту tftp для установки обратного соединения и загрузки указанного в параметрах файла-обработчика. После загрузки полученный файл передаётся в интерпретатор языка Lua, в котором выполняется типовая функция config_test() с указанием имени файла конфигурации и IP-адреса. Так как функция config_test() определена внутри загруженного с удалённой системы файла, атакующий может организовать выполнение любого Lua-кода в контексте устройства, в том числе при помощи метода os.execute() выполнить произвольные команды в системе. Обработчик TDDP запускается с правами root и не сбрасывает привилегии, поэтому и код атакующего будет выполнен с правами root. Информация о проблеме была передана в TP-Link ещё в декабре через специальную форму для информирования об уязвимостях, но компания никак не отреагировали на сообщение. После этого Гаррет попытался связаться с представителями TP-Link через Twitter, но также не получил ответа.