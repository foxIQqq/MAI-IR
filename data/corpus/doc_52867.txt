Выявлена несовместимость SMR-дисков WD с ZFS, которая может привести к потере данных

Компания iXsystems, разрабатывающая проект FreeNAS, предупредила о серьёзных проблемах с совместимостью ZFS с некоторыми новыми жёсткими дисками WD Red, выпускаемыми компанией Western Digital с использованием технологии SMR (Shingled Magnetic Recording, черепичная магнитная запись). При наихудшем сценарии использование ZFS на проблемных накопителях может привести к потере данных. Проблемы возникают с дисками WD Red ёмкостью от 2 до 6 ТБ, выпускаемыми с 2018 года, которые используют при записи технологию DM-SMR (Device-Managed Shingled Magnetic Recording) и маркируются меткой EFAX (для CMR-дисков используется идентификатор EFRX). Western Digital отметила в своём блоге, что SMR-накопители WD Red рассчитаны на применение в NAS для дома и малых предприятий, в которых устанавливается не более 8 накопителей и наблюдается нагрузка на уровне 180 ТБ в год, характерная для резервного копирования и обмена файлами. Предыдущее поколение накопителей WD Red и модели WD Red с ёмкостью от 8 ТБ, а также диски линеек WD Red Pro, WD Gold и WD Ultrastar, продолжают производиться на базе технологии CMR (Conventional Magnetic Recording) и их использование не вызывает проблем с ZFS. Суть технологии SMR в применении в диске магнитной головки, ширина которой больше ширины дорожки, что приводит к записи с частичным перекрытием соседней дорожки, т.е. любая перезапись приводит к необходимости перезаписи всей группы дорожек. Для оптимизации работы с подобными накопителями используется зонирование - пространство для хранения разбивается на зоны, составляющие группы блоков или секторов, в которые допускается лишь последовательное добавление данных с обновлением целиком всей группы блоков. В общем виде SMR-диски обладают большей эффективностью в плане потребления энергии, более доступны по цене и демонстрируют выигрыш в производительности при последовательной записи данных, но отстают при выполнении операций случайной записи, в том числе при выполнении таких операций, как перестроение массивов хранения. DM-SMR подразумевает, что операции зонирования и распределения данных управляются контроллером диска и для системы такой диск выглядит как классический жёсткий диск, не требующий отдельных манипуляций. В DM-SMR применяется косвенная логическая адресация блоков (LBA, Logical Block Addressing), напоминающая логическую адресацию в SSD-накопителях. После каждой операции случайной записи требуется выполнение фоновой операции сборки мусора, что приводит к непредсказуемым флуктуациям с производительностью. Система может пытаться применить к таким дискам оптимизации, полагая, что данные будут записаны в указанный сектор, но фактически выдаваемые контроллером сведения определяют лишь логическую структуру и на деле при распределении данных контроллер применит свои алгоритмы, учитывающие ранее размещённые данные. Поэтому перед использованием DM-SMR дисков в пуле ZFS рекомендуется произвести операцию по их обнулению со сбросом в исходное состояние. К разбору условий, при которых возникают проблемы, привлечена компания Western Digital, которая совместно с iXsystems пытается найти решение и подготовить обновление прошивки. До публикации выводов об устранении проблем накопители с новой прошивкой планируется протестировать на высоконагруженных хранилищах с FreeNAS 11.3 и TrueNAS CORE 12.0. При этом утверждается, что из-за разного трактования SMR разными производителями на некоторых видах SMR-дисков проблем с ZFS не возникает, но предпринятое iXsystems тестирование сосредоточено только на проверке дисков WD Red на базе технологии DM-SMR, а для SMR-дисков других производителей требуется дополнительное исследование. В настоящее время проблемы с ZFS доказаны и повторены в тестах как минимум для дисков WD Red 4TB WD40EFAX с прошивкой 82.00A82 и проявляются переходом в состояние сбоя при высокой нагрузке на запись, например, при выполнении перестроения хранилища после добавления в массив нового накопителя (resilvering). Предполагается, что проблема проявляется и на других моделях WD Red с той же прошивкой. При возникновении проблемы диск начинает возвращать код ошибки IDNF (Sector ID Not Found) и становится непригоден к использованию, что обрабатывается в ZFS как сбой диска и может привести к потере хранящихся на диске данных. При сбое нескольких дисков данные в vdev или пуле могут быть потеряны. Отмечается, что упомянутые сбои возникают достаточно редко - из примерно тысячи проданных систем FreeNAS Mini, которые комплектовались проблемными дисками, проблема всплыла в рабочих условиях только один раз.