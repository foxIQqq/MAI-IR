Серьёзное снижение производительности ядра 5.19, вызванное защитой от атаки Retbleed

Инженер из компании VMware обратил внимание сообщества разработчиков ядра Linux на значительное снижение производительности, при использовании ядра Linux 5.19. Тестирование виртуальной машины с ядром 5.19 в окружении гипервизора VMware ESXi показало снижение производительности вычислений на 70%, сетевых операций на 30% и действий с хранилищем на 13%, по сравнению с той же конфигурацией на базе ядра 5.18. В качестве причины снижения производительности называется изменение в коде защиты от атак класса Spectre v2 (spectre_v2=ibrs), реализованной на основе расширенных инструкций IBRS (Enhanced Indirect Branch Restricted Speculation), позволяющих адаптивно разрешать и запрещать спекулятивное выполнение инструкций во время обработки прерываний, системных вызовов и переключений контекста. Защита включена для блокирования недавно выявленной уязвимости Retbleed в механизме спекулятивного выполнения косвенных переходов CPU, позволяющей извлечь информацию из памяти ядра или организовать атаку на хост-систему из виртуальных машин. После выключения защиты (spectre_v2=off) производительность возвращается на прежний уровень.