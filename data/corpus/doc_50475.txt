В Wine Staging добавлены патчи для повышения производительности многопоточных игр

В ветку Wine Staging, включающую не полностью готовые или рискованные изменения, пока не пригодные для принятия в основную ветку Wine, добавлен набор патчей "esync" (Eventfd Synchronization), позволяющих добиться увеличения производительности многопоточных Windows игр и приложений. Патчи были подготовлены ещё летом прошлого года и используются в развиваемом компанией Valve проекте Proton, но включены в репозиторий Wine Staging только сейчас. По умолчанию esync отключен и для его активации следует установить переменную окружения WINEESYNC в значение, отличное от нуля. Использование сборки Wine с поддержкой esync значительно снижает нагрузку на CPU в некоторых играх и позволяет добиться увеличения производительности за счёт рационального использования ресурсов многоядерных CPU и эффективного распределения процессов по ядрам CPU. Esync предлагает примитивы синхронизации, реализованные поверх Linux API eventfd, который в отличие от futexes и семафоров pthread, позволяет опросить состояние сразу нескольких объектов синхронизации. Целью проекта является организация выполнения всех операций синхронизации в "пользовательском пространстве", без привлечения wineserver. При использовании esync почти все операции ожидания события выполняются на стороне ntdll, включая привязанные к объектам сервера. Сервер лишь создаёт файловый дескриптор eventfd и возвращает его в ntdll, а ntdll создаёт необходимый объект синхронизации и кэширует его. Так как esync создаёт отдельный файловый дескриптор для каждого объекта, то при запуске некоторых игр может быть превышен системный лимит на число открытых файлов. В случае вывода ошибки "eventfd: Too many open files" следует увеличить число открытых файлов через изменение настройки "nofile" в /etc/security/limits.conf, /etc/systemd/system.conf или /etc/systemd/user.conf или при помощи команды "ulimit -Hn 1048576".